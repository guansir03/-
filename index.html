<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberDeck // 云端终端</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Roboto+Mono:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-purple: #bc13fe;
            --neon-green: #0aff0a;
            --neon-red: #ff3333;
            --bg-dark: #050505;
            --bg-panel: rgba(16, 20, 24, 0.9);
            --text-main: #e0e6ed;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            margin: 0;
            height: 100vh;
            user-select: none;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; z-index: 9999; pointer-events: none; opacity: 0.15;
        }

        .cyber-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 243, 255, 0.15);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .corner-decor::before, .corner-decor::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            border: 2px solid var(--neon-cyan); transition: all 0.3s;
        }
        .corner-decor::before { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .corner-decor::after { bottom: -1px; right: -1px; border-left: none; border-top: none; }
        .corner-decor:hover::before, .corner-decor:hover::after { width: 100%; height: 100%; opacity: 0.1; background: var(--neon-cyan); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border: 1px solid var(--neon-cyan); }
        
        .font-cyber { font-family: 'Orbitron', sans-serif; }

        .view-section {
            display: none; height: 100%; width: 100%;
            animation: fadeIn 0.4s ease-in-out; position: relative; z-index: 10;
        }
        .view-section.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .hub-card {
            transition: all 0.3s; cursor: pointer;
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.2) 100%);
        }
        .hub-card:hover {
            transform: translateY(-5px); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            border-color: var(--neon-cyan);
        }

        .game-target {
            position: absolute; width: 60px; height: 60px;
            border: 2px solid var(--neon-pink); border-radius: 50%;
            background: rgba(255, 0, 255, 0.1); cursor: crosshair;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px var(--neon-pink); animation: targetPulse 1s infinite;
            z-index: 50;
        }
        @keyframes targetPulse {
            0% { box-shadow: 0 0 5px var(--neon-pink); transform: scale(1); }
            50% { box-shadow: 0 0 20px var(--neon-pink); transform: scale(1.1); }
            100% { box-shadow: 0 0 5px var(--neon-pink); transform: scale(1); }
        }

        #editor img { max-width: 100%; border: 1px solid var(--neon-pink); border-radius: 4px; margin: 10px 0; }
        
        .back-btn {
            position: absolute; top: 1rem; right: 1rem; z-index: 100;
            background: rgba(0,0,0,0.8); border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan); padding: 0.5rem 1rem;
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s;
        }
        .back-btn:hover { background: var(--neon-cyan); color: black; box-shadow: 0 0 15px var(--neon-cyan); }

        /* 设置界面样式 */
        .input-group label { display: block; color: var(--neon-cyan); font-size: 0.8rem; margin-bottom: 0.5rem; font-family: 'Orbitron'; }
        .input-group input, .input-group textarea {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #333;
            color: white; padding: 0.8rem; font-family: 'Roboto Mono';
            transition: border-color 0.3s;
        }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: var(--neon-pink); }
        
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block;
            margin-right: 6px; box-shadow: 0 0 5px currentColor;
        }
        .status-online { color: var(--neon-green); background: var(--neon-green); }
        .status-offline { color: var(--neon-red); background: var(--neon-red); }
        .status-sync { color: var(--neon-pink); background: var(--neon-pink); animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <div class="scanlines"></div>

    <!-- ==================== 视图 0: 初始化设置 (SETUP) ==================== -->
    <div id="view-setup" class="view-section flex-col items-center justify-center p-8 z-50">
        <div class="cyber-panel p-8 rounded-xl max-w-lg w-full border border-[var(--neon-pink)]">
            <h2 class="text-2xl font-cyber text-[var(--neon-pink)] mb-2 text-center">SYSTEM INITIALIZATION</h2>
            <p class="text-gray-400 text-xs text-center mb-6 font-mono">CLOUD DATABASE CONNECTION REQUIRED</p>
            
            <div class="space-y-4">
                <div class="input-group">
                    <label>FIREBASE CONFIG (JSON)</label>
                    <textarea id="firebase-config-input" rows="5" placeholder='{"apiKey": "...", "authDomain": "...", "projectId": "..."}' class="text-xs"></textarea>
                    <p class="text-[10px] text-gray-500 mt-1">* 请粘贴 Firebase 项目设置中的完整 JSON 对象</p>
                </div>
                
                <div class="input-group">
                    <label>NETRUNNER ID (连接密钥)</label>
                    <input type="text" id="net-id-input" placeholder="创建您的专属ID (如: Ghost_77)">
                    <p class="text-[10px] text-gray-500 mt-1">* 多设备同步请使用相同的 ID</p>
                </div>

                <button onclick="saveConfigAndBoot()" class="w-full bg-[var(--neon-pink)] text-black font-bold py-3 mt-4 font-cyber hover:bg-white transition-colors">
                    ESTABLISH UPLINK
                </button>
                <button onclick="bootOffline()" class="w-full border border-gray-600 text-gray-500 py-2 mt-2 text-xs hover:text-white hover:border-white transition-colors">
                    BOOT IN OFFLINE MODE
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== 视图 1: 主控中心 (HOME) ==================== -->
    <div id="view-home" class="view-section flex-col items-center justify-center p-8 relative">
        <div class="absolute top-4 left-4 font-mono text-xs text-gray-500 flex items-center gap-4">
            <div id="network-status"><span class="status-dot status-offline"></span>OFFLINE</div>
            <div id="user-display" class="text-[var(--neon-cyan)]">GUEST</div>
            <button onclick="clearConfig()" class="hover:text-red-500 underline">[RESET CONFIG]</button>
        </div>

        <div class="text-center mb-12 relative pointer-events-none">
            <h1 class="text-6xl md:text-8xl font-cyber font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500 tracking-tighter mb-2" style="text-shadow: 0 0 30px rgba(0, 243, 255, 0.3);">
                CYBER<span class="text-[var(--neon-cyan)]">DECK</span>
            </h1>
            <div class="h-1 w-24 bg-[var(--neon-cyan)] mx-auto mb-4 shadow-[0_0_10px_var(--neon-cyan)]"></div>
            <p class="text-[var(--text-dim)] tracking-[0.5em] text-sm">CLOUD TERMINAL v3.0</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
            <div onclick="window.switchView('view-notes')" class="hub-card cyber-panel p-8 rounded-xl border border-gray-700 flex flex-col items-center text-center group corner-decor">
                <div class="w-20 h-20 rounded-full bg-black/50 border border-gray-600 flex items-center justify-center mb-6 group-hover:border-[var(--neon-cyan)] transition-colors">
                    <i class="fas fa-brain text-3xl text-gray-400"></i>
                </div>
                <h2 class="text-2xl font-cyber font-bold mb-2 group-hover:text-[var(--neon-cyan)]">MEMORY BANK</h2>
                <p class="text-gray-500 text-sm">访问云端记忆碎片<br>全平台实时同步</p>
            </div>

            <div onclick="window.switchView('view-game')" class="hub-card cyber-panel p-8 rounded-xl border border-gray-700 flex flex-col items-center text-center group corner-decor">
                <div class="w-20 h-20 rounded-full bg-black/50 border border-gray-600 flex items-center justify-center mb-6 group-hover:border-[var(--neon-pink)] transition-colors">
                    <i class="fas fa-eye text-3xl text-gray-400"></i>
                </div>
                <h2 class="text-2xl font-cyber font-bold mb-2 group-hover:text-[var(--neon-pink)]">VISUAL CORTEX</h2>
                <p class="text-gray-500 text-sm">动态视力校准程序<br>提高反应速度与追踪能力</p>
            </div>
        </div>
    </div>

    <!-- ==================== 视图 2: 笔记应用 (NOTES) ==================== -->
    <div id="view-notes" class="view-section flex-col md:flex-row p-4 md:p-8 gap-6 max-w-[1600px] mx-auto w-full h-full relative">
        <button onclick="window.switchView('view-home')" class="back-btn"><i class="fas fa-arrow-left mr-2"></i>EXIT</button>

        <aside class="w-full md:w-1/4 min-w-[250px] cyber-panel flex flex-col rounded-lg overflow-hidden h-[30%] md:h-full">
            <div class="p-4 border-b border-gray-800 bg-black/40 flex justify-between items-center">
                <h2 class="text-xl font-cyber font-bold text-[var(--neon-cyan)]">ARCHIVES</h2>
                <div id="sync-indicator" class="text-[10px] text-gray-500"><i class="fas fa-circle"></i> READY</div>
            </div>
            <div class="p-3">
                <button onclick="createNewNote()" class="w-full border border-[var(--neon-cyan)] text-[var(--neon-cyan)] py-2 px-4 text-sm font-bold hover:bg-[var(--neon-cyan)] hover:text-black transition-colors mb-2">
                    + NEW DATA
                </button>
                <input type="text" id="search-box" placeholder="SEARCH..." class="w-full bg-black/50 border border-gray-700 text-white text-sm rounded p-2 focus:border-[var(--neon-cyan)] focus:outline-none">
            </div>
            <div id="note-list" class="flex-1 overflow-y-auto px-2 pb-2 space-y-1"></div>
        </aside>

        <main class="flex-1 cyber-panel flex flex-col rounded-lg overflow-hidden relative h-[68%] md:h-full mt-4 md:mt-0">
            <header class="h-14 border-b border-gray-800 bg-black/40 flex items-center justify-between px-6">
                <input type="text" id="note-title" placeholder="UNTITLED_DATA" class="bg-transparent border-none text-lg font-bold text-[var(--neon-cyan)] focus:outline-none w-1/2 font-cyber">
                <div class="flex items-center gap-4">
                    <span id="save-status" class="text-[10px] text-gray-500 font-mono">IDLE</span>
                    <button onclick="document.getElementById('img-up').click()" class="text-gray-400 hover:text-[var(--neon-pink)]"><i class="fas fa-image"></i></button>
                    <button onclick="deleteCurrentNote()" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    <input type="file" id="img-up" accept="image/*" class="hidden">
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 bg-black/20 relative custom-scrollbar">
                <div id="editor" contenteditable="true" class="prose prose-invert max-w-none focus:outline-none min-h-full text-gray-300 font-mono leading-relaxed" placeholder="输入数据..."></div>
            </div>
        </main>
    </div>

    <!-- ==================== 视图 3: 视觉游戏 (GAME) ==================== -->
    <div id="view-game" class="view-section flex-col items-center justify-center relative w-full h-full">
        <button onclick="endGame()" class="back-btn"><i class="fas fa-arrow-left mr-2"></i>ABORT</button>
        <div id="game-ui" class="text-center z-20 relative">
            <h2 class="text-4xl font-cyber text-[var(--neon-pink)] mb-2">TARGET PRACTICE</h2>
            <div class="flex gap-8 mb-12 justify-center font-mono text-xl">
                <div class="p-4 border border-gray-700 rounded bg-black/50 min-w-[150px]">
                    <div class="text-xs text-gray-500">SCORE</div>
                    <div id="game-score" class="text-[var(--neon-green)] text-3xl">0</div>
                </div>
                <div class="p-4 border border-gray-700 rounded bg-black/50 min-w-[150px]">
                    <div class="text-xs text-gray-500">TIME</div>
                    <div id="game-timer" class="text-[var(--neon-cyan)] text-3xl">30.0</div>
                </div>
            </div>
            <button onclick="startGame()" id="start-btn" class="px-12 py-4 bg-[var(--neon-pink)] text-black font-bold font-cyber text-xl hover:bg-white hover:shadow-[0_0_20px_var(--neon-pink)] transition-all cursor-pointer">
                INITIATE SEQUENCE
            </button>
        </div>
        <div id="game-area" class="absolute top-0 left-0 w-full h-full hidden overflow-hidden"></div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- 全局状态 ---
        let db, auth, notesUnsubscribe;
        let localNotes = []; // 用于离线模式或缓存
        let currentNoteId = null;
        let isOnline = false;
        let netrunnerId = "GUEST";
        let saveTimeout;

        // --- 1. 初始化引导系统 ---
        window.addEventListener('DOMContentLoaded', () => {
            const storedConfig = localStorage.getItem('cyber_firebase_config');
            const storedId = localStorage.getItem('cyber_net_id');

            if (storedConfig && storedId) {
                tryInitFirebase(JSON.parse(storedConfig), storedId);
            } else {
                window.switchView('view-setup');
            }
        });

        // 尝试连接 Firebase
        async function tryInitFirebase(config, id) {
            try {
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                netrunnerId = id;
                
                // 尝试启用离线持久化 (让页面加载更快)
                try { await enableIndexedDbPersistence(db); } catch (err) {}

                await signInAnonymously(auth);
                
                isOnline = true;
                updateNetworkStatus('ONLINE', 'status-online');
                document.getElementById('user-display').innerText = `NETRUNNER: ${netrunnerId}`;
                
                // 初始化笔记监听
                initNotesListener();
                window.switchView('view-home');

            } catch (e) {
                console.error("Firebase Init Failed:", e);
                alert("连接失败：请检查配置 JSON 是否正确。\n\nError: " + e.message);
                window.switchView('view-setup');
            }
        }

        // 监听 Firestore 数据变化
        function initNotesListener() {
            if (!db) return;
            const notesRef = collection(db, 'cyberdeck_users', netrunnerId, 'notes');
            const q = query(notesRef, orderBy('timestamp', 'desc'));

            document.getElementById('sync-indicator').innerHTML = '<i class="fas fa-sync fa-spin text-[var(--neon-pink)]"></i> SYNCING';

            notesUnsubscribe = onSnapshot(q, (snapshot) => {
                localNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNoteList();
                
                // 如果当前有打开的笔记，刷新内容（除了正在编辑的）
                if (currentNoteId) {
                    const current = localNotes.find(n => n.id === currentNoteId);
                    // 只有当编辑器没焦点时才强行刷新，防止打字被打断
                    if (current && document.activeElement.id !== 'editor' && document.activeElement.id !== 'note-title') {
                       loadNoteToUI(current);
                    }
                } else if (localNotes.length > 0 && window.location.hash !== '#editor') {
                    // 默认加载第一条
                    loadNote(localNotes[0].id);
                }
                
                document.getElementById('sync-indicator').innerHTML = '<i class="fas fa-circle text-[var(--neon-green)]"></i> LIVE';
            }, (error) => {
                console.error("Sync Error:", error);
                updateNetworkStatus('ERROR', 'status-offline');
            });
        }

        // --- 2. 笔记逻辑 (Cloud Version) ---
        
        window.createNewNote = async function() {
            if (!isOnline) return alert("需要连接网络才能创建数据。");
            
            const newNote = {
                title: '',
                content: '',
                timestamp: Date.now()
            };

            try {
                const docRef = await addDoc(collection(db, 'cyberdeck_users', netrunnerId, 'notes'), newNote);
                currentNoteId = docRef.id;
                // 列表会自动刷新因为 onSnapshot
                document.getElementById('note-title').value = '';
                document.getElementById('editor').innerHTML = '';
                document.getElementById('note-title').focus();
            } catch (e) {
                console.error("Create failed", e);
            }
        };

        window.loadNote = function(id) {
            const note = localNotes.find(n => n.id === id);
            if (!note) return;
            currentNoteId = id;
            loadNoteToUI(note);
            renderNoteList();
        };

        function loadNoteToUI(note) {
            document.getElementById('note-title').value = note.title || '';
            document.getElementById('editor').innerHTML = note.content || '';
        }

        function renderNoteList() {
            const list = document.getElementById('note-list');
            const search = document.getElementById('search-box').value.toLowerCase();
            list.innerHTML = '';
            
            localNotes.filter(n => (n.title || '').toLowerCase().includes(search) || (n.content || '').toLowerCase().includes(search))
                .forEach(n => {
                    const active = n.id === currentNoteId;
                    const div = document.createElement('div');
                    div.className = `p-3 mb-1 rounded cursor-pointer transition-all border-l-2 ${active ? 'border-[var(--neon-cyan)] bg-[var(--neon-cyan)]/10' : 'border-transparent hover:bg-white/5'}`;
                    div.innerHTML = `
                        <div class="font-bold truncate text-sm ${active ? 'text-[var(--neon-cyan)]' : 'text-gray-300'}">${n.title || 'UNTITLED'}</div>
                        <div class="text-[10px] text-gray-500 font-mono mt-1">${new Date(n.timestamp).toLocaleDateString()} ${new Date(n.timestamp).toLocaleTimeString()}</div>
                    `;
                    div.onclick = () => window.loadNote(n.id);
                    list.appendChild(div);
                });
        }

        // 自动保存逻辑
        window.triggerSave = function() {
            const status = document.getElementById('save-status');
            status.innerText = "WRITING...";
            status.className = "text-[10px] text-[var(--neon-pink)] font-mono";
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToCloud, 1000);
        };

        async function saveToCloud() {
            if (!currentNoteId || !isOnline) return;
            
            const title = document.getElementById('note-title').value;
            const content = document.getElementById('editor').innerHTML;
            
            try {
                const noteRef = doc(db, 'cyberdeck_users', netrunnerId, 'notes', currentNoteId);
                await updateDoc(noteRef, {
                    title: title,
                    content: content,
                    timestamp: Date.now()
                });
                
                const status = document.getElementById('save-status');
                status.innerText = "SYNCED";
                status.className = "text-[10px] text-[var(--neon-cyan)] font-mono";
                setTimeout(() => status.innerText = "IDLE", 2000);
            } catch (e) {
                console.error("Save failed", e);
                document.getElementById('save-status').innerText = "ERROR";
            }
        }

        window.deleteCurrentNote = async function() {
            if (!currentNoteId) return;
            if(confirm('确认从云端删除此数据？')) {
                try {
                    await deleteDoc(doc(db, 'cyberdeck_users', netrunnerId, 'notes', currentNoteId));
                    currentNoteId = null;
                    // UI 更新由 snapshot 处理
                } catch (e) {
                    alert("删除失败");
                }
            }
        };

        // --- 3. 辅助功能 ---
        
        window.saveConfigAndBoot = function() {
            const configStr = document.getElementById('firebase-config-input').value;
            const netId = document.getElementById('net-id-input').value || "GUEST_" + Math.floor(Math.random()*1000);
            
            try {
                const config = JSON.parse(configStr);
                localStorage.setItem('cyber_firebase_config', JSON.stringify(config));
                localStorage.setItem('cyber_net_id', netId);
                tryInitFirebase(config, netId);
            } catch (e) {
                alert("配置格式错误！必须是有效的 JSON 格式。");
            }
        };
        
        window.clearConfig = function() {
            if(confirm("确定要重置系统配置吗？本地缓存将被清除。")) {
                localStorage.removeItem('cyber_firebase_config');
                localStorage.removeItem('cyber_net_id');
                location.reload();
            }
        }

        window.bootOffline = function() {
            isOnline = false;
            alert("离线模式：数据将不会保存到云端（仅限本次会话）。");
            window.switchView('view-home');
            updateNetworkStatus('LOCAL ONLY', 'status-offline');
        };

        function updateNetworkStatus(text, classInfo) {
            const el = document.getElementById('network-status');
            el.innerHTML = `<span class="status-dot ${classInfo}"></span>${text}`;
        }

        // 绑定事件 (Module 作用域隔离，需挂载到 window)
        window.switchView = function(viewId) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                if (viewId === el.id) el.classList.add('active');
            });
        };

        // 监听输入
        document.getElementById('note-title').addEventListener('input', window.triggerSave);
        document.getElementById('editor').addEventListener('input', window.triggerSave);
        document.getElementById('search-box').addEventListener('input', renderNoteList);
        
        // 图片上传
        document.getElementById('img-up').addEventListener('change', function(e) {
            if(this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.execCommand('insertHTML', false, `<img src="${e.target.result}"><br>`);
                    window.triggerSave();
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // --- 4. 游戏逻辑 (复用) ---
        // 游戏逻辑保持不变，为了节省篇幅，这里简化引用
        // ... (游戏逻辑与之前版本相同，仅变量挂载到 window) ...
        let gameActive = false;
        let score = 0;
        let timeLeft = 30;
        let gameTimerInterval, spawnTimerTimeout;
        const gameArea = document.getElementById('game-area');

        window.startGame = function() {
            gameActive = true; score = 0; timeLeft = 30; updateGameUI();
            document.getElementById('game-ui').classList.add('hidden');
            gameArea.classList.remove('hidden'); gameArea.innerHTML = '';
            gameTimerInterval = setInterval(() => {
                timeLeft -= 0.1; if (timeLeft <= 0) endGame(true); updateGameUI();
            }, 100);
            spawnTarget();
        };

        function spawnTarget() {
            if (!gameActive) return;
            const t = document.createElement('div'); t.className = 'game-target';
            const x = Math.random() * (gameArea.clientWidth - 80) + 10;
            const y = Math.random() * (gameArea.clientHeight - 80) + 10;
            t.style.left = x + 'px'; t.style.top = y + 'px';
            t.onmousedown = (e) => {
                e.stopPropagation(); score += 10; t.remove(); updateGameUI();
                clearTimeout(spawnTimerTimeout); spawnTarget();
            };
            gameArea.appendChild(t);
            spawnTimerTimeout = setTimeout(() => {
                if (t.parentElement) { t.remove(); if (gameActive) spawnTarget(); }
            }, Math.max(500, 2000 - score * 5));
        }

        function updateGameUI() {
            document.getElementById('game-score').innerText = score;
            document.getElementById('game-timer').innerText = Math.max(0, timeLeft).toFixed(1);
        }

        window.endGame = function(f=false) {
            gameActive = false; clearInterval(gameTimerInterval); clearTimeout(spawnTimerTimeout);
            gameArea.classList.add('hidden'); document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('start-btn').innerText = f ? "RETRY" : "START";
            if (!f) window.switchView('view-home');
        };

        // --- 5. 背景动画 (Module IIFE) ---
        (function() {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            let w, h, particles = [];
            const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
            window.addEventListener('resize', resize); resize();
            class P {
                constructor() { this.reset(); }
                reset() { this.x = Math.random()*w; this.y = Math.random()*h; this.vx = (Math.random()-0.5)*0.5; this.vy = (Math.random()-0.5)*0.5; this.color = Math.random()>0.5 ? '#00f3ff' : '#bc13fe'; }
                update() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>w||this.y<0||this.y>h) this.reset(); }
                draw() { ctx.globalAlpha = 0.3; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 1, 0, Math.PI*2); ctx.fill(); }
            }
            for(let i=0; i<80; i++) particles.push(new P());
            function animate() {
                ctx.clearRect(0, 0, w, h);
                ctx.strokeStyle = 'rgba(0, 243, 255, 0.02)'; ctx.lineWidth = 1;
                for (let x = 0; x < w; x += 60) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke(); }
                particles.forEach(p => {
                    p.update(); p.draw();
                    particles.forEach(p2 => {
                        let d = Math.hypot(p.x-p2.x, p.y-p2.y);
                        if (d < 100) { ctx.beginPath(); ctx.strokeStyle = p.color; ctx.globalAlpha = 1 - d/100; ctx.lineWidth = 0.5; ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
                    });
                });
                requestAnimationFrame(animate);
            }
            animate();
        })();

    </script>
</body>
</html>
