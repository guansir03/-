<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberDeck // 云端终端 [Word-Class]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Roboto+Mono:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-purple: #bc13fe;
            --neon-green: #0aff0a;
            --bg-dark: #050505;
            --bg-panel: rgba(16, 20, 24, 0.95);
            --text-main: #e0e6ed;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            margin: 0;
            height: 100vh;
            user-select: none;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; z-index: 9999; pointer-events: none; opacity: 0.15;
        }

        .cyber-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 243, 255, 0.15);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .corner-decor::before, .corner-decor::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            border: 2px solid var(--neon-cyan); transition: all 0.3s;
        }
        .corner-decor::before { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .corner-decor::after { bottom: -1px; right: -1px; border-left: none; border-top: none; }
        .corner-decor:hover::before, .corner-decor:hover::after { width: 100%; height: 100%; opacity: 0.1; background: var(--neon-cyan); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border: 1px solid var(--neon-cyan); }
        
        .font-cyber { font-family: 'Orbitron', sans-serif; }

        .view-section {
            display: none; height: 100%; width: 100%;
            animation: fadeIn 0.4s ease-in-out; position: relative; z-index: 10;
        }
        .view-section.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .hub-card {
            transition: all 0.3s; cursor: pointer;
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.2) 100%);
        }
        .hub-card:hover {
            transform: translateY(-5px); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            border-color: var(--neon-cyan);
        }

        .game-target {
            position: absolute; width: 60px; height: 60px;
            border: 2px solid var(--neon-pink); border-radius: 50%;
            background: rgba(255, 0, 255, 0.1); cursor: crosshair;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px var(--neon-pink); animation: targetPulse 1s infinite;
            z-index: 50;
        }
        @keyframes targetPulse {
            0% { box-shadow: 0 0 5px var(--neon-pink); transform: scale(1); }
            50% { box-shadow: 0 0 20px var(--neon-pink); transform: scale(1.1); }
            100% { box-shadow: 0 0 5px var(--neon-pink); transform: scale(1); }
        }

        .back-btn {
            position: absolute; top: 1rem; right: 1rem; z-index: 100;
            background: rgba(0,0,0,0.8); border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan); padding: 0.5rem 1rem;
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s;
        }
        .back-btn:hover { background: var(--neon-cyan); color: black; box-shadow: 0 0 15px var(--neon-cyan); }

        /* 设置界面样式 */
        .input-group label { display: block; color: var(--neon-cyan); font-size: 0.8rem; margin-bottom: 0.5rem; font-family: 'Orbitron'; }
        .input-group input, .input-group textarea {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #333;
            color: white; padding: 0.8rem; font-family: 'Roboto Mono';
            transition: border-color 0.3s;
        }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: var(--neon-pink); }
        
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block;
            margin-right: 6px; box-shadow: 0 0 5px currentColor;
        }
        .status-online { color: var(--neon-green); background: var(--neon-green); }
        .status-offline { color: var(--neon-red); background: var(--neon-red); }
        
        /* --- 编辑器增强样式 --- */
        .editor-toolbar {
            display: flex; gap: 0.4rem; padding: 0.6rem 1rem;
            background: rgba(0,0,0,0.5); border-bottom: 1px solid #333;
            flex-wrap: wrap; align-items: center;
        }
        .tool-btn {
            color: #9ca3af; padding: 0.4rem 0.6rem; border: 1px solid transparent;
            border-radius: 4px; font-size: 0.85rem; transition: all 0.2s; cursor: pointer;
            min-width: 32px; display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { color: var(--neon-cyan); background: rgba(0, 243, 255, 0.15); border-color: rgba(0, 243, 255, 0.3); }
        .tool-btn.active { color: var(--neon-pink); background: rgba(255, 0, 255, 0.15); border-color: rgba(255, 0, 255, 0.3); }
        .tool-separator { width: 1px; height: 20px; background: #4b5563; margin: 0 0.3rem; }
        
        /* 编辑器内部排版 */
        #editor {
            line-height: 1.8;
            padding-bottom: 100px;
        }
        #editor h1 { font-size: 2em; font-weight: bold; color: var(--neon-cyan); margin: 0.8em 0 0.4em; border-bottom: 1px solid rgba(0, 243, 255, 0.2); padding-bottom: 0.2em; }
        #editor h2 { font-size: 1.5em; font-weight: bold; color: var(--neon-pink); margin: 0.8em 0 0.4em; }
        #editor h3 { font-size: 1.25em; font-weight: bold; color: var(--neon-purple); margin: 0.8em 0 0.4em; }
        #editor blockquote { border-left: 4px solid var(--neon-cyan); padding-left: 1em; margin: 1em 0; color: #94a3b8; font-style: italic; background: rgba(0, 243, 255, 0.05); padding: 10px; }
        #editor ul { list-style-type: disc; padding-left: 1.5em; margin: 0.5em 0; }
        #editor ol { list-style-type: decimal; padding-left: 1.5em; margin: 0.5em 0; }
        #editor li { margin-bottom: 0.2em; }
        #editor hr { border: 0; border-top: 1px dashed #4b5563; margin: 2em 0; }
        #editor img { max-width: 100%; border: 1px solid var(--neon-pink); border-radius: 4px; margin: 10px 0; box-shadow: 0 0 10px rgba(255,0,255,0.1); }

        /* 大纲索引样式 */
        .outline-item {
            padding: 4px 8px; cursor: pointer; font-size: 0.8rem;
            color: #9ca3af; transition: all 0.2s; border-left: 2px solid transparent;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .outline-item:hover { color: var(--neon-cyan); background: rgba(255,255,255,0.05); }
        .outline-h1 { padding-left: 10px; font-weight: bold; color: #e0e6ed; }
        .outline-h2 { padding-left: 25px; }
        .outline-h3 { padding-left: 40px; font-size: 0.75rem; opacity: 0.8; }
        
        /* 占位符 */
        [contenteditable]:empty:before { content: attr(placeholder); color: #555; display: block; }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <div class="scanlines"></div>

    <!-- ==================== 视图 0: 初始化设置 (SETUP) ==================== -->
    <div id="view-setup" class="view-section flex-col items-center justify-center p-8 z-50">
        <div class="cyber-panel p-8 rounded-xl max-w-lg w-full border border-[var(--neon-pink)]">
            <h2 class="text-2xl font-cyber text-[var(--neon-pink)] mb-2 text-center">SYSTEM INITIALIZATION</h2>
            <div class="space-y-4">
                <div class="input-group">
                    <label>FIREBASE CONFIG (JSON)</label>
                    <textarea id="firebase-config-input" rows="8" placeholder="粘贴 firebaseConfig" class="text-xs font-mono"></textarea>
                </div>
                <div class="input-group">
                    <label>NETRUNNER ID</label>
                    <input type="text" id="net-id-input" placeholder="如: Ghost_77">
                </div>
                <button onclick="saveConfigAndBoot()" class="w-full bg-[var(--neon-pink)] text-black font-bold py-3 mt-4 font-cyber hover:bg-white transition-colors">
                    ESTABLISH UPLINK
                </button>
                <button onclick="bootOffline()" class="w-full border border-gray-600 text-gray-500 py-2 mt-2 text-xs hover:text-white hover:border-white transition-colors">
                    BOOT IN OFFLINE MODE
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== 视图 1: 主控中心 (HOME) ==================== -->
    <div id="view-home" class="view-section flex-col items-center justify-center p-8 relative">
        <div class="absolute top-4 left-4 font-mono text-xs text-gray-500 flex items-center gap-4">
            <div id="network-status"><span class="status-dot status-offline"></span>OFFLINE</div>
            <div id="user-display" class="text-[var(--neon-cyan)]">GUEST</div>
            <button onclick="clearConfig()" class="hover:text-red-500 underline">[RESET]</button>
        </div>
        <div class="text-center mb-12 relative pointer-events-none">
            <h1 class="text-6xl md:text-8xl font-cyber font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500 tracking-tighter mb-2" style="text-shadow: 0 0 30px rgba(0, 243, 255, 0.3);">
                CYBER<span class="text-[var(--neon-cyan)]">DECK</span>
            </h1>
            <p class="text-[var(--text-dim)] tracking-[0.5em] text-sm">CLOUD TERMINAL v3.4 [WORD-CLASS]</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
            <div onclick="window.switchView('view-notes')" class="hub-card cyber-panel p-8 rounded-xl border border-gray-700 flex flex-col items-center text-center group corner-decor">
                <i class="fas fa-brain text-3xl text-gray-400 mb-4"></i>
                <h2 class="text-2xl font-cyber font-bold mb-2 text-[var(--neon-cyan)]">MEMORY BANK</h2>
                <p class="text-gray-500 text-sm">文档编辑器 & 云端同步</p>
            </div>
            <div onclick="window.switchView('view-game')" class="hub-card cyber-panel p-8 rounded-xl border border-gray-700 flex flex-col items-center text-center group corner-decor">
                <i class="fas fa-eye text-3xl text-gray-400 mb-4"></i>
                <h2 class="text-2xl font-cyber font-bold mb-2 text-[var(--neon-pink)]">VISUAL CORTEX</h2>
                <p class="text-gray-500 text-sm">动态视力训练程序</p>
            </div>
        </div>
    </div>

    <!-- ==================== 视图 2: 笔记应用 (NOTES) ==================== -->
    <div id="view-notes" class="view-section flex-col md:flex-row p-4 md:p-6 gap-4 max-w-[1800px] mx-auto w-full h-full relative">
        
        <!-- 左侧：文件列表 (15%) -->
        <aside class="w-full md:w-[18%] min-w-[200px] cyber-panel flex flex-col rounded-lg overflow-hidden h-[20%] md:h-full border-r border-gray-800">
            <div class="p-3 border-b border-gray-800 bg-black/40 flex justify-between items-center">
                <button onclick="window.switchView('view-home')" class="text-[10px] border border-[var(--neon-cyan)] text-[var(--neon-cyan)] px-2 py-1 hover:bg-[var(--neon-cyan)] hover:text-black transition-colors">
                    <i class="fas fa-chevron-left"></i> HOME
                </button>
                <h2 class="text-sm font-cyber font-bold text-gray-400">FILES</h2>
            </div>
            <div class="p-2 bg-black/20">
                <button onclick="createNewNote()" class="w-full border border-[var(--neon-cyan)] text-[var(--neon-cyan)] py-1.5 text-xs font-bold hover:bg-[var(--neon-cyan)] hover:text-black transition-colors mb-2">
                    + NEW DOC
                </button>
                <input type="text" id="search-box" placeholder="SEARCH..." class="w-full bg-black/50 border border-gray-700 text-white text-xs rounded p-1.5 focus:border-[var(--neon-cyan)] focus:outline-none">
            </div>
            <div id="note-list" class="flex-1 overflow-y-auto px-2 pb-2 space-y-1 mt-1 custom-scrollbar"></div>
            <div class="p-2 text-[10px] text-gray-600 text-center border-t border-gray-800" id="sync-indicator">SYNC READY</div>
        </aside>

        <!-- 中间：编辑器 (65%) -->
        <main class="flex-1 cyber-panel flex flex-col rounded-lg overflow-hidden relative h-[60%] md:h-full shadow-2xl">
            
            <!-- 顶部：标题 & 状态 -->
            <header class="h-12 border-b border-gray-700 bg-black/60 flex items-center justify-between px-4 shrink-0">
                <input type="text" id="note-title" placeholder="UNTITLED_DOCUMENT" class="bg-transparent border-none text-lg font-bold text-[var(--neon-cyan)] focus:outline-none w-2/3 font-cyber">
                <div class="flex items-center gap-3">
                    <span id="save-status" class="text-[10px] text-gray-500 font-mono">IDLE</span>
                    <button onclick="deleteCurrentNote()" class="text-gray-400 hover:text-red-500 transition-colors px-2"><i class="fas fa-trash-alt"></i></button>
                </div>
            </header>

            <!-- 顶部：Word 级工具栏 -->
            <div class="editor-toolbar shrink-0">
                <!-- 历史 -->
                <button class="tool-btn" onclick="formatDoc('undo')" title="Undo"><i class="fas fa-undo"></i></button>
                <button class="tool-btn" onclick="formatDoc('redo')" title="Redo"><i class="fas fa-redo"></i></button>
                <div class="tool-separator"></div>
                
                <!-- 格式 -->
                <button class="tool-btn font-bold" onclick="formatDoc('bold')" title="Bold">B</button>
                <button class="tool-btn italic" onclick="formatDoc('italic')" title="Italic">I</button>
                <button class="tool-btn underline" onclick="formatDoc('underline')" title="Underline">U</button>
                <button class="tool-btn line-through" onclick="formatDoc('strikeThrough')" title="Strike">S</button>
                <div class="tool-separator"></div>

                <!-- 标题 -->
                <button class="tool-btn" onclick="formatDoc('formatBlock', 'H1')" title="Heading 1"><span class="font-bold text-lg">H1</span></button>
                <button class="tool-btn" onclick="formatDoc('formatBlock', 'H2')" title="Heading 2"><span class="font-bold text-base">H2</span></button>
                <button class="tool-btn" onclick="formatDoc('formatBlock', 'H3')" title="Heading 3"><span class="font-bold text-sm">H3</span></button>
                <button class="tool-btn" onclick="formatDoc('formatBlock', 'P')" title="Paragraph"><i class="fas fa-paragraph"></i></button>
                <div class="tool-separator"></div>

                <!-- 对齐 -->
                <button class="tool-btn" onclick="formatDoc('justifyLeft')" title="Left"><i class="fas fa-align-left"></i></button>
                <button class="tool-btn" onclick="formatDoc('justifyCenter')" title="Center"><i class="fas fa-align-center"></i></button>
                <button class="tool-btn" onclick="formatDoc('justifyRight')" title="Right"><i class="fas fa-align-right"></i></button>
                <div class="tool-separator"></div>

                <!-- 列表 & 引用 -->
                <button class="tool-btn" onclick="formatDoc('insertUnorderedList')" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                <button class="tool-btn" onclick="formatDoc('insertOrderedList')" title="Number List"><i class="fas fa-list-ol"></i></button>
                <button class="tool-btn" onclick="formatDoc('indent')" title="Indent"><i class="fas fa-indent"></i></button>
                <button class="tool-btn" onclick="formatDoc('outdent')" title="Outdent"><i class="fas fa-outdent"></i></button>
                <button class="tool-btn" onclick="formatDoc('formatBlock', 'blockquote')" title="Quote"><i class="fas fa-quote-right"></i></button>
                <div class="tool-separator"></div>

                <!-- 插入 -->
                <button class="tool-btn" onclick="formatDoc('insertHorizontalRule')" title="Line">HR</button>
                <button class="tool-btn" onclick="document.getElementById('img-up').click()" title="Image"><i class="fas fa-image"></i></button>
                <button class="tool-btn text-red-400" onclick="formatDoc('removeFormat')" title="Clear Format"><i class="fas fa-eraser"></i></button>
                
                <input type="file" id="img-up" accept="image/*" class="hidden">
            </div>

            <!-- 编辑内容区 -->
            <div class="flex-1 overflow-y-auto bg-black/30 relative custom-scrollbar flex justify-center">
                <!-- 模拟 A4 纸张效果 (但在赛博风格下是全宽的) -->
                <div id="editor" contenteditable="true" class="w-full max-w-4xl px-8 py-6 text-gray-300 focus:outline-none" placeholder="Begin transmission..."></div>
            </div>
        </main>

        <!-- 右侧：大纲索引 (17%) -->
        <aside class="w-full md:w-[17%] min-w-[180px] cyber-panel flex flex-col rounded-lg overflow-hidden h-[20%] md:h-full border-l border-gray-800 hidden md:flex">
            <div class="p-3 border-b border-gray-800 bg-black/40">
                <h2 class="text-xs font-cyber font-bold text-[var(--neon-pink)]">NEURAL LINK</h2>
                <p class="text-[9px] text-gray-500">DOCUMENT STRUCTURE</p>
            </div>
            <div id="outline-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                <div class="text-gray-600 text-xs text-center mt-4 italic">No headers found...</div>
            </div>
        </aside>
    </div>

    <!-- ==================== 视图 3: 视觉游戏 ==================== -->
    <div id="view-game" class="view-section flex-col items-center justify-center relative w-full h-full">
        <button onclick="endGame()" class="back-btn"><i class="fas fa-times"></i> ABORT</button>
        <div id="game-ui" class="text-center z-20 relative">
            <h2 class="text-4xl font-cyber text-[var(--neon-pink)] mb-2">TARGET PRACTICE</h2>
            <div class="flex gap-8 mb-12 justify-center font-mono text-xl">
                <div class="p-4 border border-gray-700 rounded bg-black/50 min-w-[150px]">
                    <div class="text-xs text-gray-500">SCORE</div>
                    <div id="game-score" class="text-[var(--neon-green)] text-3xl">0</div>
                </div>
                <div class="p-4 border border-gray-700 rounded bg-black/50 min-w-[150px]">
                    <div class="text-xs text-gray-500">TIME</div>
                    <div id="game-timer" class="text-[var(--neon-cyan)] text-3xl">30.0</div>
                </div>
            </div>
            <button onclick="startGame()" id="start-btn" class="px-12 py-4 bg-[var(--neon-pink)] text-black font-bold font-cyber text-xl hover:bg-white hover:shadow-[0_0_20px_var(--neon-pink)] transition-all cursor-pointer">INITIATE SEQUENCE</button>
        </div>
        <div id="game-area" class="absolute top-0 left-0 w-full h-full hidden overflow-hidden"></div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        let db, auth, notesUnsubscribe;
        let localNotes = []; 
        let currentNoteId = null;
        let isOnline = false;
        let netrunnerId = "GUEST";
        let saveTimeout;

        window.addEventListener('DOMContentLoaded', () => {
            const storedConfig = localStorage.getItem('cyber_firebase_config');
            const storedId = localStorage.getItem('cyber_net_id');
            if (storedConfig && storedId) {
                tryInitFirebase(JSON.parse(storedConfig), storedId);
            } else {
                window.switchView('view-setup');
            }
        });

        // --- 核心：编辑器功能 ---
        window.formatDoc = function(cmd, value) {
            document.execCommand(cmd, false, value);
            document.getElementById('editor').focus();
            window.triggerSave(); // 格式变化也触发保存
        };

        // --- 核心：大纲索引生成器 ---
        window.updateOutline = function() {
            const editor = document.getElementById('editor');
            const outlineList = document.getElementById('outline-list');
            const headers = editor.querySelectorAll('h1, h2, h3');
            
            outlineList.innerHTML = '';

            if (headers.length === 0) {
                outlineList.innerHTML = '<div class="text-gray-600 text-xs text-center mt-4 italic">No headers...</div>';
                return;
            }

            headers.forEach((header, index) => {
                const item = document.createElement('div');
                const tagName = header.tagName.toLowerCase();
                
                // 设置锚点ID
                if (!header.id) header.id = `header-${index}`;

                item.innerText = header.innerText || '(Empty Title)';
                item.className = `outline-item outline-${tagName}`;
                item.onclick = () => {
                    header.scrollIntoView({ behavior: 'smooth', block: 'center' });
                };
                outlineList.appendChild(item);
            });
        };

        async function tryInitFirebase(config, id) {
            try {
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                netrunnerId = id;
                try { await enableIndexedDbPersistence(db); } catch (err) {}
                await signInAnonymously(auth);
                isOnline = true;
                updateNetworkStatus('ONLINE', 'status-online');
                document.getElementById('user-display').innerText = `NETRUNNER: ${netrunnerId}`;
                initNotesListener();
                window.switchView('view-home');
            } catch (e) {
                console.error("Firebase Init Failed:", e);
                alert("连接失败。\nError: " + e.message);
                window.switchView('view-setup');
            }
        }

        function initNotesListener() {
            if (!db) return;
            const notesRef = collection(db, 'cyberdeck_users', netrunnerId, 'notes');
            const q = query(notesRef, orderBy('timestamp', 'desc'));
            document.getElementById('sync-indicator').innerHTML = '<i class="fas fa-sync fa-spin text-[var(--neon-pink)]"></i> SYNCING';

            notesUnsubscribe = onSnapshot(q, (snapshot) => {
                localNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNoteList();
                if (currentNoteId) {
                    const current = localNotes.find(n => n.id === currentNoteId);
                    if (current && document.activeElement.id !== 'editor' && document.activeElement.id !== 'note-title') {
                       loadNoteToUI(current);
                    }
                } else if (localNotes.length > 0 && window.location.hash !== '#editor') {
                    window.loadNote(localNotes[0].id);
                }
                document.getElementById('sync-indicator').innerHTML = '<i class="fas fa-circle text-[var(--neon-green)]"></i> LIVE';
            }, (error) => {
                console.error("Sync Error:", error);
                updateNetworkStatus('ERROR', 'status-offline');
            });
        }

        window.createNewNote = async function() {
            if (!isOnline) return alert("需要连接网络。");
            const newNote = { title: '', content: '', timestamp: Date.now() };
            try {
                const docRef = await addDoc(collection(db, 'cyberdeck_users', netrunnerId, 'notes'), newNote);
                currentNoteId = docRef.id;
                document.getElementById('note-title').value = '';
                document.getElementById('editor').innerHTML = '';
                document.getElementById('note-title').focus();
                window.updateOutline(); // 重置大纲
            } catch (e) { console.error("Create failed", e); }
        };

        window.loadNote = function(id) {
            const note = localNotes.find(n => n.id === id);
            if (!note) return;
            currentNoteId = id;
            loadNoteToUI(note);
            renderNoteList();
        };

        function loadNoteToUI(note) {
            document.getElementById('note-title').value = note.title || '';
            document.getElementById('editor').innerHTML = note.content || '';
            window.updateOutline(); // 加载笔记时生成大纲
        }

        function renderNoteList() {
            const list = document.getElementById('note-list');
            const search = document.getElementById('search-box').value.toLowerCase();
            list.innerHTML = '';
            localNotes.filter(n => (n.title || '').toLowerCase().includes(search) || (n.content || '').toLowerCase().includes(search))
                .forEach(n => {
                    const active = n.id === currentNoteId;
                    const div = document.createElement('div');
                    div.className = `p-2 mb-1 rounded cursor-pointer transition-all border-l-2 ${active ? 'border-[var(--neon-cyan)] bg-[var(--neon-cyan)]/10' : 'border-transparent hover:bg-white/5'}`;
                    div.innerHTML = `
                        <div class="font-bold truncate text-xs ${active ? 'text-[var(--neon-cyan)]' : 'text-gray-300'}">${n.title || 'UNTITLED'}</div>
                        <div class="text-[9px] text-gray-500 font-mono">${new Date(n.timestamp).toLocaleDateString()}</div>
                    `;
                    div.onclick = () => window.loadNote(n.id);
                    list.appendChild(div);
                });
        }

        window.triggerSave = function() {
            const status = document.getElementById('save-status');
            status.innerText = "WRITING...";
            status.className = "text-[10px] text-[var(--neon-pink)] font-mono border-pink-500 text-pink-500";
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToCloud, 1000);
            
            // 实时更新大纲 (防抖)
            window.updateOutline();
        };

        async function saveToCloud() {
            if (!currentNoteId || !isOnline) return;
            const title = document.getElementById('note-title').value;
            const content = document.getElementById('editor').innerHTML;
            try {
                const noteRef = doc(db, 'cyberdeck_users', netrunnerId, 'notes', currentNoteId);
                await updateDoc(noteRef, { title: title, content: content, timestamp: Date.now() });
                const status = document.getElementById('save-status');
                status.innerText = "SYNCED";
                status.className = "text-[10px] font-mono border-cyan-500 text-[var(--neon-cyan)]";
                setTimeout(() => { status.innerText = "IDLE"; status.className = "text-[10px] text-gray-500 font-mono border border-gray-700 px-2 py-0.5 rounded"; }, 2000);
            } catch (e) {
                console.error("Save failed", e);
                document.getElementById('save-status').innerText = "ERROR";
            }
        }

        window.deleteCurrentNote = async function() {
            if (!currentNoteId) return;
            if(confirm('确认删除？')) {
                try {
                    await deleteDoc(doc(db, 'cyberdeck_users', netrunnerId, 'notes', currentNoteId));
                    currentNoteId = null;
                    document.getElementById('note-title').value = "";
                    document.getElementById('editor').innerHTML = "";
                    window.updateOutline();
                } catch (e) { alert("删除失败"); }
            }
        };

        window.saveConfigAndBoot = function() {
            let configStr = document.getElementById('firebase-config-input').value.trim();
            if (configStr.indexOf('=') > -1) configStr = configStr.split('=')[1].trim();
            if (configStr.endsWith(';')) configStr = configStr.slice(0, -1);
            const netId = document.getElementById('net-id-input').value || "GUEST_" + Math.floor(Math.random()*1000);
            try {
                const config = new Function("return " + configStr)();
                localStorage.setItem('cyber_firebase_config', JSON.stringify(config));
                localStorage.setItem('cyber_net_id', netId);
                tryInitFirebase(config, netId);
            } catch (e) {
                alert("配置解析失败！" + e.message);
            }
        };
        
        window.clearConfig = function() {
            if(confirm("确定重置配置？")) {
                localStorage.removeItem('cyber_firebase_config');
                localStorage.removeItem('cyber_net_id');
                location.reload();
            }
        }

        window.bootOffline = function() {
            isOnline = false;
            alert("离线模式");
            window.switchView('view-home');
            updateNetworkStatus('LOCAL ONLY', 'status-offline');
        };

        function updateNetworkStatus(text, classInfo) {
            document.getElementById('network-status').innerHTML = `<span class="status-dot ${classInfo}"></span>${text}`;
        }

        window.switchView = function(viewId) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                if (viewId === el.id) el.classList.add('active');
            });
        };

        document.getElementById('note-title').addEventListener('input', window.triggerSave);
        document.getElementById('editor').addEventListener('input', window.triggerSave);
        document.getElementById('search-box').addEventListener('input', renderNoteList);
        document.getElementById('img-up').addEventListener('change', function(e) {
            if(this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.execCommand('insertHTML', false, `<img src="${e.target.result}"><br>`);
                    window.triggerSave();
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        let gameActive = false; let score = 0; let timeLeft = 30;
        let gameTimerInterval, spawnTimerTimeout;
        const gameArea = document.getElementById('game-area');

        window.startGame = function() {
            gameActive = true; score = 0; timeLeft = 30; updateGameUI();
            document.getElementById('game-ui').classList.add('hidden');
            gameArea.classList.remove('hidden'); gameArea.innerHTML = '';
            gameTimerInterval = setInterval(() => {
                timeLeft -= 0.1; if (timeLeft <= 0) endGame(true); updateGameUI();
            }, 100);
            spawnTarget();
        };

        function spawnTarget() {
            if (!gameActive) return;
            const t = document.createElement('div'); t.className = 'game-target';
            const x = Math.random() * (gameArea.clientWidth - 80) + 10;
            const y = Math.random() * (gameArea.clientHeight - 80) + 10;
            t.style.left = x + 'px'; t.style.top = y + 'px';
            t.onmousedown = (e) => {
                e.stopPropagation(); score += 10; t.remove(); updateGameUI();
                clearTimeout(spawnTimerTimeout); spawnTarget();
            };
            gameArea.appendChild(t);
            spawnTimerTimeout = setTimeout(() => {
                if (t.parentElement) { t.remove(); if (gameActive) spawnTarget(); }
            }, Math.max(500, 2000 - score * 5));
        }

        function updateGameUI() {
            document.getElementById('game-score').innerText = score;
            document.getElementById('game-timer').innerText = Math.max(0, timeLeft).toFixed(1);
        }

        window.endGame = function(f=false) {
            gameActive = false; clearInterval(gameTimerInterval); clearTimeout(spawnTimerTimeout);
            gameArea.classList.add('hidden'); document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('start-btn').innerText = f ? "RETRY" : "START";
            if (!f) window.switchView('view-home');
        };

        (function() {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            let w, h, particles = [];
            const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
            window.addEventListener('resize', resize); resize();
            class P {
                constructor() { this.reset(); }
                reset() { this.x = Math.random()*w; this.y = Math.random()*h; this.vx = (Math.random()-0.5)*0.5; this.vy = (Math.random()-0.5)*0.5; this.color = Math.random()>0.5 ? '#00f3ff' : '#bc13fe'; }
                update() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>w||this.y<0||this.y>h) this.reset(); }
                draw() { ctx.globalAlpha = 0.3; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 1, 0, Math.PI*2); ctx.fill(); }
            }
            for(let i=0; i<80; i++) particles.push(new P());
            function animate() {
                ctx.clearRect(0, 0, w, h);
                ctx.strokeStyle = 'rgba(0, 243, 255, 0.02)'; ctx.lineWidth = 1;
                for (let x = 0; x < w; x += 60) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke(); }
                particles.forEach(p => {
                    p.update(); p.draw();
                    particles.forEach(p2 => {
                        let d = Math.hypot(p.x-p2.x, p.y-p2.y);
                        if (d < 100) { ctx.beginPath(); ctx.strokeStyle = p.color; ctx.globalAlpha = 1 - d/100; ctx.lineWidth = 0.5; ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
                    });
                });
                requestAnimationFrame(animate);
            }
            animate();
        })();

    </script>
</body>
</html>
