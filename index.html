<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberDeck // 个人终端 [Stable]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Roboto+Mono:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-purple: #bc13fe;
            --neon-green: #0aff0a;
            --bg-dark: #050505;
            --bg-panel: rgba(16, 20, 24, 0.85);
            --text-main: #e0e6ed;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            margin: 0;
            height: 100vh;
            user-select: none;
        }

        /* 动态背景 Canvas */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* 降低背景层级 */
        }

        /* 扫描线效果 */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            z-index: 9999;
            pointer-events: none; /* 关键：允许点击穿透 */
            opacity: 0.15;
        }

        /* 通用面板样式 */
        .cyber-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 243, 255, 0.15);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        /* 角落装饰 */
        .corner-decor::before, .corner-decor::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid var(--neon-cyan);
            transition: all 0.3s;
        }
        .corner-decor::before { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .corner-decor::after { bottom: -1px; right: -1px; border-left: none; border-top: none; }
        .corner-decor:hover::before, .corner-decor:hover::after { width: 100%; height: 100%; opacity: 0.1; background: var(--neon-cyan); }

        /* 滚动条 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border: 1px solid var(--neon-cyan); }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }

        .font-cyber { font-family: 'Orbitron', sans-serif; }

        /* 视图切换逻辑 */
        .view-section {
            display: none;
            height: 100%;
            width: 100%;
            animation: fadeIn 0.4s ease-in-out;
            position: relative;
            z-index: 10; /* 提高内容层级，确保可点击 */
        }
        .view-section.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* 首页卡片 */
        .hub-card {
            transition: all 0.3s;
            cursor: pointer;
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.2) 100%);
            user-select: none;
        }
        .hub-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            border-color: var(--neon-cyan);
            background: rgba(255,255,255,0.05);
        }
        .hub-card:active {
            transform: scale(0.98);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
        }

        /* 游戏目标样式 */
        .game-target {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid var(--neon-pink);
            border-radius: 50%;
            background: rgba(255, 0, 255, 0.1);
            cursor: crosshair;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px var(--neon-pink);
            animation: targetPulse 1s infinite;
            user-select: none;
            z-index: 50;
        }
        @keyframes targetPulse {
            0% { box-shadow: 0 0 5px var(--neon-pink); transform: scale(1); }
            50% { box-shadow: 0 0 20px var(--neon-pink); transform: scale(1.1); }
            100% { box-shadow: 0 0 5px var(--neon-pink); transform: scale(1); }
        }

        #editor img { max-width: 100%; border: 1px solid var(--neon-pink); border-radius: 4px; margin: 10px 0; }
        
        /* 返回按钮 */
        .back-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 100; /* 最高层级 */
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            padding: 0.5rem 1rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .back-btn:hover { background: var(--neon-cyan); color: black; box-shadow: 0 0 15px var(--neon-cyan); }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <div class="scanlines"></div>

    <!-- ==================== 视图 1: 主控中心 (HOME) ==================== -->
    <div id="view-home" class="view-section active flex-col items-center justify-center p-8 relative">
        
        <div class="text-center mb-12 relative pointer-events-none"> <!-- 标题不阻挡点击 -->
            <h1 class="text-6xl md:text-8xl font-cyber font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500 tracking-tighter mb-2" style="text-shadow: 0 0 30px rgba(0, 243, 255, 0.3);">
                CYBER<span class="text-[var(--neon-cyan)]">DECK</span>
            </h1>
            <div class="h-1 w-24 bg-[var(--neon-cyan)] mx-auto mb-4 shadow-[0_0_10px_var(--neon-cyan)]"></div>
            <p class="text-[var(--text-dim)] tracking-[0.5em] text-sm">PERSONAL TERMINAL v2.1 [STABLE]</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
            <!-- 卡片 1: 记忆模块 -->
            <div onclick="window.switchView('view-notes')" class="hub-card cyber-panel p-8 rounded-xl border border-gray-700 flex flex-col items-center text-center group corner-decor">
                <div class="w-20 h-20 rounded-full bg-black/50 border border-gray-600 flex items-center justify-center mb-6 group-hover:border-[var(--neon-cyan)] transition-colors">
                    <i class="fas fa-brain text-3xl text-gray-400"></i>
                </div>
                <h2 class="text-2xl font-cyber font-bold mb-2 group-hover:text-[var(--neon-cyan)]">MEMORY BANK</h2>
                <p class="text-gray-500 text-sm">访问神经元记忆碎片<br>支持图文混排与持久化存储</p>
            </div>

            <!-- 卡片 2: 视觉训练 -->
            <div onclick="window.switchView('view-game')" class="hub-card cyber-panel p-8 rounded-xl border border-gray-700 flex flex-col items-center text-center group corner-decor">
                <div class="w-20 h-20 rounded-full bg-black/50 border border-gray-600 flex items-center justify-center mb-6 group-hover:border-[var(--neon-pink)] transition-colors">
                    <i class="fas fa-eye text-3xl text-gray-400"></i>
                </div>
                <h2 class="text-2xl font-cyber font-bold mb-2 group-hover:text-[var(--neon-pink)]">VISUAL CORTEX</h2>
                <p class="text-gray-500 text-sm">动态视力校准程序<br>提高反应速度与追踪能力</p>
            </div>
        </div>

        <footer class="absolute bottom-8 text-xs text-gray-700 font-mono">
            SYSTEM STATUS: ONLINE // SECURE CONNECTION
        </footer>
    </div>

    <!-- ==================== 视图 2: 笔记应用 (NOTES) ==================== -->
    <div id="view-notes" class="view-section flex-col md:flex-row p-4 md:p-8 gap-6 max-w-[1600px] mx-auto w-full h-full relative">
        <button onclick="window.switchView('view-home')" class="back-btn"><i class="fas fa-arrow-left mr-2"></i>EXIT</button>

        <aside class="w-full md:w-1/4 min-w-[250px] cyber-panel flex flex-col rounded-lg overflow-hidden h-[30%] md:h-full">
            <div class="p-4 border-b border-gray-800 bg-black/40">
                <h2 class="text-xl font-cyber font-bold text-[var(--neon-cyan)]">ARCHIVES</h2>
            </div>
            <div class="p-3">
                <button onclick="createNewNote()" class="w-full border border-[var(--neon-cyan)] text-[var(--neon-cyan)] py-2 px-4 text-sm font-bold hover:bg-[var(--neon-cyan)] hover:text-black transition-colors mb-2">
                    + NEW DATA
                </button>
                <input type="text" id="search-box" placeholder="SEARCH..." class="w-full bg-black/50 border border-gray-700 text-white text-sm rounded p-2 focus:border-[var(--neon-cyan)] focus:outline-none">
            </div>
            <div id="note-list" class="flex-1 overflow-y-auto px-2 pb-2 space-y-1"></div>
        </aside>

        <main class="flex-1 cyber-panel flex flex-col rounded-lg overflow-hidden relative h-[68%] md:h-full mt-4 md:mt-0">
            <header class="h-14 border-b border-gray-800 bg-black/40 flex items-center justify-between px-6">
                <input type="text" id="note-title" placeholder="UNTITLED_DATA" class="bg-transparent border-none text-lg font-bold text-[var(--neon-cyan)] focus:outline-none w-1/2 font-cyber">
                <div class="flex items-center gap-4">
                    <span id="save-status" class="text-[10px] text-green-500 font-mono">READY</span>
                    <button onclick="document.getElementById('img-up').click()" class="text-gray-400 hover:text-[var(--neon-pink)]"><i class="fas fa-image"></i></button>
                    <button onclick="deleteCurrentNote()" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    <input type="file" id="img-up" accept="image/*" class="hidden">
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 bg-black/20 relative custom-scrollbar">
                <div id="editor" contenteditable="true" class="prose prose-invert max-w-none focus:outline-none min-h-full text-gray-300 font-mono leading-relaxed" placeholder="输入数据..."></div>
            </div>
        </main>
    </div>

    <!-- ==================== 视图 3: 视觉游戏 (GAME) ==================== -->
    <div id="view-game" class="view-section flex-col items-center justify-center relative w-full h-full">
        <button onclick="endGame()" class="back-btn"><i class="fas fa-arrow-left mr-2"></i>ABORT</button>
        
        <div id="game-ui" class="text-center z-20 relative">
            <h2 class="text-4xl font-cyber text-[var(--neon-pink)] mb-2">TARGET PRACTICE</h2>
            <p class="text-gray-400 mb-8 font-mono text-sm">点击出现的节点以拦截数据包</p>
            
            <div class="flex gap-8 mb-12 justify-center font-mono text-xl">
                <div class="p-4 border border-gray-700 rounded bg-black/50 min-w-[150px]">
                    <div class="text-xs text-gray-500">SCORE</div>
                    <div id="game-score" class="text-[var(--neon-green)] text-3xl">0</div>
                </div>
                <div class="p-4 border border-gray-700 rounded bg-black/50 min-w-[150px]">
                    <div class="text-xs text-gray-500">TIME</div>
                    <div id="game-timer" class="text-[var(--neon-cyan)] text-3xl">30.0</div>
                </div>
            </div>

            <button onclick="startGame()" id="start-btn" class="px-12 py-4 bg-[var(--neon-pink)] text-black font-bold font-cyber text-xl hover:bg-white hover:shadow-[0_0_20px_var(--neon-pink)] transition-all clip-path-btn cursor-pointer">
                INITIATE SEQUENCE
            </button>
        </div>

        <div id="game-area" class="absolute top-0 left-0 w-full h-full hidden overflow-hidden"></div>
    </div>

    <script>
        // ==================== 1. 系统核心 (修复版) ====================
        
        // 使用 var 避免重复声明错误
        var SafeStorage = {
            get: (key) => {
                try {
                    return JSON.parse(localStorage.getItem(key));
                } catch (e) {
                    console.warn('Storage access failed, using memory mode');
                    return window['__mem_' + key];
                }
            },
            set: (key, val) => {
                try {
                    localStorage.setItem(key, JSON.stringify(val));
                } catch (e) {
                    window['__mem_' + key] = val;
                }
            }
        };

        window.switchView = function(viewId) {
            const views = document.querySelectorAll('.view-section');
            views.forEach(el => {
                el.classList.remove('active');
                void el.offsetWidth;
            });
            
            const target = document.getElementById(viewId);
            if (target) {
                target.classList.add('active');
            } else {
                console.error('Target view not found:', viewId);
            }

            if (viewId === 'view-home') {
                stopGameLoop();
            }
        };

        // ==================== 2. 笔记系统 ====================
        // 改用 var 声明
        var notes = SafeStorage.get('cyberNotes_v2') || [];
        var currentNoteId = null;
        var saveTimeout;

        function initNotes() {
            if (!Array.isArray(notes)) notes = [];
            if (notes.length === 0) createNewNote();
            else {
                currentNoteId = notes[0].id;
                renderNoteList();
                loadNote(currentNoteId);
            }
        }

        window.createNewNote = function() {
            const note = { id: Date.now(), title: '', content: '', timestamp: Date.now() };
            notes.unshift(note);
            currentNoteId = note.id;
            saveNotes();
            renderNoteList();
            loadNote(note.id);
            
            if(document.getElementById('view-notes').classList.contains('active')) {
                document.getElementById('note-title').focus();
            }
        };

        function loadNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;
            currentNoteId = id;
            document.getElementById('note-title').value = note.title || '';
            document.getElementById('editor').innerHTML = note.content || '';
            renderNoteList();
        }

        function renderNoteList() {
            const list = document.getElementById('note-list');
            const search = document.getElementById('search-box').value.toLowerCase();
            list.innerHTML = '';
            
            notes.filter(n => (n.title || '').toLowerCase().includes(search) || (n.content || '').toLowerCase().includes(search))
                .forEach(n => {
                    const active = n.id === currentNoteId;
                    const div = document.createElement('div');
                    div.className = `p-3 mb-1 rounded cursor-pointer transition-all border-l-2 ${active ? 'border-[var(--neon-cyan)] bg-[var(--neon-cyan)]/10' : 'border-transparent hover:bg-white/5'}`;
                    div.innerHTML = `
                        <div class="font-bold truncate text-sm ${active ? 'text-[var(--neon-cyan)]' : 'text-gray-300'}">${n.title || 'UNTITLED'}</div>
                        <div class="text-[10px] text-gray-500 font-mono mt-1">${new Date(n.timestamp).toLocaleDateString()}</div>
                    `;
                    div.onclick = () => loadNote(n.id);
                    list.appendChild(div);
                });
        }

        function saveCurrentNote() {
            if (!currentNoteId) return;
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.title = document.getElementById('note-title').value;
                note.content = document.getElementById('editor').innerHTML;
                note.timestamp = Date.now();
                
                notes = notes.filter(n => n.id !== currentNoteId);
                notes.unshift(note);
                
                saveNotes();
                renderNoteList();
                
                const status = document.getElementById('save-status');
                status.innerText = "SAVED";
                status.className = "text-[10px] text-[var(--neon-cyan)] font-mono";
            }
        }

        function saveNotes() {
            SafeStorage.set('cyberNotes_v2', notes);
        }

        window.deleteCurrentNote = function() {
            if(confirm('DELETE DATA?')) {
                notes = notes.filter(n => n.id !== currentNoteId);
                saveNotes();
                if(notes.length === 0) createNewNote();
                else {
                    currentNoteId = notes[0].id;
                    loadNote(currentNoteId);
                }
                renderNoteList();
            }
        };

        // 事件绑定
        document.getElementById('note-title').addEventListener('input', triggerSave);
        document.getElementById('editor').addEventListener('input', triggerSave);
        document.getElementById('search-box').addEventListener('input', renderNoteList);
        
        function triggerSave() {
            const status = document.getElementById('save-status');
            status.innerText = "WRITING...";
            status.className = "text-[10px] text-[var(--neon-pink)] font-mono";
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveCurrentNote, 800);
        }

        document.getElementById('img-up').addEventListener('change', function(e) {
            if(this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.execCommand('insertHTML', false, `<img src="${e.target.result}"><br>`);
                    saveCurrentNote();
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // ==================== 3. 游戏系统 ====================
        var gameActive = false;
        var score = 0;
        var timeLeft = 30;
        var gameTimerInterval;
        var spawnTimerTimeout;
        var gameArea = document.getElementById('game-area');

        window.startGame = function() {
            gameActive = true;
            score = 0;
            timeLeft = 30;
            updateGameUI();
            
            document.getElementById('game-ui').classList.add('hidden');
            gameArea.classList.remove('hidden');
            gameArea.innerHTML = '';

            gameTimerInterval = setInterval(() => {
                timeLeft -= 0.1;
                if (timeLeft <= 0) endGame(true);
                updateGameUI();
            }, 100);

            spawnTarget();
        };

        function spawnTarget() {
            if (!gameActive) return;

            const target = document.createElement('div');
            target.className = 'game-target';
            
            const maxX = Math.max(100, gameArea.clientWidth - 80);
            const maxY = Math.max(100, gameArea.clientHeight - 80);
            const x = Math.random() * maxX + 10;
            const y = Math.random() * maxY + 10;
            
            target.style.left = x + 'px';
            target.style.top = y + 'px';

            target.onmousedown = (e) => {
                e.stopPropagation();
                score += 10;
                createBurst(x, y);
                target.remove();
                updateGameUI();
                clearTimeout(spawnTimerTimeout);
                spawnTarget(); 
            };

            gameArea.appendChild(target);

            const difficulty = Math.max(500, 2000 - (score * 5)); 
            spawnTimerTimeout = setTimeout(() => {
                if (target.parentElement) {
                    target.remove();
                    if (gameActive) spawnTarget();
                }
            }, difficulty);
        }

        function createBurst(x, y) {
            const burst = document.createElement('div');
            burst.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:60px;height:60px;border:2px solid white;border-radius:50%;animation:ping 0.3s linear;pointer-events:none;z-index:60;`;
            gameArea.appendChild(burst);
            setTimeout(() => burst.remove(), 300);
        }

        function updateGameUI() {
            document.getElementById('game-score').innerText = score;
            document.getElementById('game-timer').innerText = Math.max(0, timeLeft).toFixed(1);
        }

        window.stopGameLoop = function() {
            gameActive = false;
            clearInterval(gameTimerInterval);
            clearTimeout(spawnTimerTimeout);
        };

        window.endGame = function(finished = false) {
            window.stopGameLoop();
            gameArea.classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('start-btn').innerText = finished ? "RETRY SEQUENCE" : "INITIATE SEQUENCE";
            if (finished === false) window.switchView('view-home');
        };

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes ping { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
            .clip-path-btn { clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px); }
        `;
        document.head.appendChild(styleSheet);

        // ==================== 4. 背景与初始化 ====================
        
        try { initNotes(); } catch(e) { console.error(e); }

        // 将背景动画逻辑封装在 IIFE 中，避免 w 变量冲突
        (function() {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            let w, h, particles = []; // 这里声明的 w 不会与全局冲突
            
            function initCanvas() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', initCanvas);
            initCanvas();

            class P {
                constructor() { this.reset(); }
                reset() {
                    this.x = Math.random() * w;
                    this.y = Math.random() * h;
                    this.vx = (Math.random() - 0.5) * 0.5;
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.color = Math.random() > 0.5 ? '#00f3ff' : '#bc13fe';
                }
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.x < 0 || this.x > w || this.y < 0 || this.y > h) this.reset();
                }
                draw() {
                    ctx.globalAlpha = 0.3;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 1, 0, Math.PI*2);
                    ctx.fill();
                }
            }

            for(let i=0; i<80; i++) particles.push(new P());

            function animate() {
                ctx.clearRect(0, 0, w, h);
                ctx.strokeStyle = 'rgba(0, 243, 255, 0.02)';
                ctx.lineWidth = 1;
                for (let x = 0; x < w; x += 60) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke(); }
                
                particles.forEach(p => {
                    p.update();
                    p.draw();
                    particles.forEach(p2 => {
                        let dx = p.x - p2.x, dy = p.y - p2.y;
                        let d = Math.sqrt(dx*dx + dy*dy);
                        if (d < 100) {
                            ctx.beginPath();
                            ctx.strokeStyle = p.color;
                            ctx.globalAlpha = 1 - d/100;
                            ctx.lineWidth = 0.5;
                            ctx.moveTo(p.x, p.y);
                            ctx.lineTo(p2.x, p2.y);
                            ctx.stroke();
                        }
                    });
                });
                requestAnimationFrame(animate);
            }
            animate();
        })();

    </script>
</body>
</html>